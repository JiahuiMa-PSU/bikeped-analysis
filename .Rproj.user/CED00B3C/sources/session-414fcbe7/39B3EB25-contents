---
title: "Monthly bike volume trend using data from three states (2019-2023)"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
    
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r global, include=FALSE}

library(flexdashboard)
library(dplyr)
library(readr)
library(ggplot2)
#library(tidyverse)
library(plotly)
library(shiny)

## make sure to compile data file into three columns: state, functional_classification, start_time (formatted as yyyy-mm-dd) 
## read in data and mutate "month" and "year"

# monthly mean daily volume by detectors
monthly_mean <- read.csv('data/mean_daily_vol_per_month.csv')

monthly_mean <- monthly_mean %>%
  mutate(month = factor(format(as.Date(date), "%b"), levels = month.abb),
         year = as.integer(format(as.Date(date), "%Y")))
# average daily volume by functional classification
monthly_mean_function <- monthly_mean %>%
  group_by(state, functional_classification, month, year) %>%
  summarize(avg_daily_vol = mean(mean_volume)) %>% 
  mutate_if(is.numeric, round, 2)
# average daily volume by facility type
monthly_mean_facility <- monthly_mean %>%
  group_by(state, facility_type, month, year) %>%
  summarize(avg_daily_vol = mean(mean_volume)) %>% 
  mutate_if(is.numeric, round, 2)


```

Sidebar {.sidebar}
======================================================================
```{r echo = FALSE}
tags$br()
# Define inputs
selectInput("stateInput", "Select a State", choices = unique(monthly_mean_function$state))

selectInput("funcClassInput", "Select a Functional Classification", choices = unique(monthly_mean_function$functional_classification))

selectInput("facilityInput", "Select a Facility Type", choices = unique(monthly_mean_facility$facility_type))

selectInput("yearInput", "Select a year", choices = unique(monthly_mean_function$year))

```

Use the upper plot to see the monthly volume change through the years for your chosen state and functional classification.

Use the lower plot to compare the three states for your chosen year and functional classification.
<br>
<br>
<br>
<br>
Application author: [Jiahui Ma](www.linkedin.com/in/jiahui-ma-988623105)

Data source: [BikePed Portal](https://bikeped.trec.pdx.edu/)

Plots
======================================================================
Row
-----------------------------------------------------------------------

### Single state: comparison over time (2019-2023) for selected facility type

```{r echo = FALSE}

# Server logic to create reactive Plotly plot based on user input
output$trafficVolumePlot = renderPlotly({
  
  # Reactive expression to filter dataset based on user input
  filtered_data <- reactive({
    monthly_mean_function %>%
      filter(state == input$stateInput, functional_classification == input$funcClassInput)
  })
  
  # Create the Plotly object
  p <- plot_ly(data = filtered_data(), x = ~month, y = ~avg_daily_vol, color = ~factor(year), type = 'scatter', mode = 'lines+markers',
               line = list(width = 2), marker = list(size = 10)) %>%
      layout(title = paste("Monthly Change in Average Volume for", input$stateInput, "&", input$funcClassInput),
             xaxis = list(title = "Month"),
             yaxis = list(title = "Average Volume"),
             legend = list(title = list(text='Year')))
  
  p # Return the plot
})

# Render the Plotly plot
plotlyOutput("trafficVolumePlot")

```

Row
-----------------------------------------------------------------------
### Comparison between three states for selected year and facility type
``` {r echo = FALSE}

# Server logic to create reactive Plotly plot based on user input
output$statesPlot = renderPlotly({
  
  # Reactive expression to filter dataset based on user input
  filtered_data <- reactive({
    monthly_mean_function %>%
      filter(year == input$yearInput, functional_classification == input$funcClassInput)
  })
  
  # Create the Plotly object
  p2 <- plot_ly(data = filtered_data(), x = ~month, y = ~avg_daily_vol, color = ~state, type = 'scatter', mode = 'lines+markers',
               line = list(width = 2), marker = list(size = 10)) %>%
      layout(title = paste("Monthly Change in Average Volume for", input$yearInput, "&", input$funcClassInput),
             xaxis = list(title = "Month"),
             yaxis = list(title = "Average Volume"))
             legend = list(title = list(text='State'))
  
  p2 # Return the plot
})

# Render the Plotly plot
plotlyOutput("statesPlot")

```
